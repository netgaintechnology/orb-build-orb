description: |
  terraform plan

executor: terraform

parameters:
  main-dir:
    type: string
    default: .
    description: |
      Directory within to lint all terraform files,
      defaults to the working directory (.)

steps:
  - update_alpine_and_checkout
  - run: echo $CIRCLE_BRANCH
  - run: echo $CIRCLE_PULL_REQUEST
  - run: |
      if [[ $(echo "$CIRCLE_BRANCH" | grep -c "pull") -gt 0 ]]; then
        echo "Skip doing stuff since it is a PR."
      else
        echo "Not a PR, so now do what I want."
      fi
  - run: |
      cat \<<~EOF > ~/.terraformrc
        # Terraform CLI config
        credentials "app.terraform.io" {
          token = "$TFIO_TOKEN"
        }
  - run: terraform workspace new dev
  - run: terraform init -upgrade <<parameters.main-dir>>
  - run: terraform plan <<parameters.main-dir>>
