description: |
  terraform plan

executor: terraform

parameters:
  main-dir:
    type: string
    default: .
    description: |
      Directory within to lint all terraform files,
      defaults to the working directory (.)
  tf-workspace:
    type: string
    default: prod
    description: |
      Terraform workspace to use

steps:
  - update_alpine_and_checkout
  - run: |
      cat \<<~EOF > ~/.terraformrc
        # Terraform CLI config
        credentials "app.terraform.io" {
          token = "$TFIO_TOKEN"
        }

  # Add Github creds for private repo use, conditional on env vars being present
  - when:
      condition: $GITHUB_USER
      steps:
        - run:
            name: Set Github User
            command: |
              echo "https://$GITHUB_USER:$GITHUB_TOKEN@github.com" > ~/.git-credentials

  - when:
      condition: $GITHUB_USER
      steps:
        - run:
            name: Set Github Cred Helper
            command: |
              echo "[user]"  > ~/.gitconfig
              echo "  name = $GITHUB_USER" >> ~/.gitconfig
              echo "[credential]" >> ~/.gitconfig
              echo "  helper = store" >> ~/.gitconfig
              
  - run: terraform workspace new <<parameters.tf-workspace>>
  - run: terraform init -upgrade <<parameters.main-dir>>
  - run: terraform plan -input=flase <<parameters.main-dir>>
